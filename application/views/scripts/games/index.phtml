<?php
/** 
 * controller => games
 * action => index
 */
$this->headTitle($this->game->type->typeName . ' ' . $this->game->sport);
$this->headLink()->prependStylesheet($this->baseUrl() . '/css/game.css');
$this->headLink()->prependStylesheet($this->baseUrl() . '/css/profile.css');
$this->headScript()->prependFile($this->baseUrl() . '/js/game.js');
$this->headScript()->prependFile($this->baseUrl() . '/js/profile.js');
?>

<?php
echo $this->placeholder('absolute')->captureStart();
	echo $this->partial('partials/global/alertBack.phtml');
	echo $this->alert()->start('confirm-action','');
	echo 	"<p class='width-100 clear center'>&nbsp;Are you sure you want to <span id='confirm-action-text'></span>?</p>";
	echo	"<p class='button clear' id='confirm-action'>Yes</p>";
	echo	"<p class='button' id='deny-action'>No</p>";
	echo $this->alert()->end();	
echo $this->placeholder('absolute')->captureEnd();

// Narrow left column
$this->placeholder('narrowColumn')->captureStart();

if ($this->userInGame) {
	// User is attending, show quick stats
	if ($this->gameOn) {	
		echo "<div class='green-back white heavy narrow-overlay-container dropshadow'>" . $this->totalPlayers . " " . ($this->totalPlayers == 1 ? 'player' : 'players') . "</div>";
	} else {
		echo "<div class='dark-red-back white heavy narrow-overlay-container dropshadow' tooltip='" . ($this->game->minPlayers - $this->totalPlayers) . " more players are needed in order for the game to happen.'>"
			 . $this->playersNeeded  . " needed
			 </div>";
	}
}

echo "<img src='" . $this->game->getProfilePic('large', 'parks') . "' class='rounded-corners narrow-column-picture dropshadow'/>";

$ratings = array('skill', 'sportsmanship', 'attendance');

if ($this->game->players->hasValue('users')) {
	// Players exist, show average ratings
	echo "<div class='profile-narrow-rating-container clear'>";
	foreach ($ratings as $rating) {
		echo $this->partial('partials/global/ratingBar.phtml', array('rating' => $this->game->getAverage($rating),
																	 'ratingLabel' => $rating));
	}
	echo "</div>";
} else {
	// No players
	echo "<p class='width-100 left center light'>No players</p>";
}


echo "<div class='width-100 left narrow-column-calendar-container'>";
echo 	$this->calendar()->createCalendar(array($this->game), true);
echo "</div>";



$this->placeholder('narrowColumn')->captureEnd();

// Store universal game details in hidden container
echo "<span id='game-details' 
			gameID='" . $this->game->gameID . "' 
			idType='gameID' 
			actingUserID='" . $this->user->userID . "' 
			captain='" . $this->captain . "'
			city='" . $this->game->city . "'
			rosterLimit='" . $this->game->rosterLimit . "'
			sport='" . $this->game->sport . "'
			public='" . ($this->isPublic ? 'public' : 'private') . "'
	 </span>";
?>

<?php
if ($this->pastGame) {
	// This game already happened
	echo "<div class='red-alert-box red heavy'>This game already happened!</div>";
} elseif ($this->todayGame) {
	// This game is happening today
	echo "<div class='green-alert-box green heavy'>This game is happening today at " . $this->game->gameDate->format('g:ia') . "!</div>";
}
?>
<header class='clear profile-name-container'>
	<p class='profile-name heavy darkest clear'>
    	<?php echo $this->gameTitle;?>
	</p>
    <div class='profile-city-container clear'>
        <p class='darkest heavy clear largest-text'>
            <?php echo $this->game->getDay() . ' at ' . $this->game->getHour();?>
        </p>  
        <a href='/parks/<?php echo $this->game->park->parkID;?>' class='clear dark larger-text game-location'><?php echo $this->game->park->parkName;?></a>
        <p class='left light game-distance'>&nbsp;&nbsp;<?php echo $this->game->park->getDistanceFromUser($this->user->location->latitude, $this->user->location->longitude);?> miles</p>  

    </div>

</header>

<div id='profile-buttons-container'>
    <?php
		
		if ($this->userInGame) {
			// You are in game
			?>
            <p class='darkest smaller-text right current-position'>You are currently attending.</p>
			<p class='red-button clear-right leave-button margin-top right' id='leave-button' style='margin-right:0'>
				Leave
			</p>
    <?php } else {
			$lower = '';
			$class = '';
			$text = 'Join';
			$id    = 'join-button';
			if (!$this->game->sportupCreated && $this->hasCaptain) {
				// Not sportup created team, allow any user to join without request
				$text = 'Request to Join';
				$id   = 'request-join-button';
			}
			if ($this->game->minSkill > $this->user->getSport($this->game->sport)->skill) {
				// User is not good enough for this team
				$class = 'transparent default';
				$id = '';
				$lower = '<p class="light clear-right smaller-text margin-top">You must have a minimum skill of ' . $this->team->minSkill . ' to join.';
			}
			?>
    		<p class='green-button right larger-text join-button heavy <?php echo $class;?>' id='<?php echo $id;?>'>
            	<?php echo $text;?>
            </p>
            <?php echo $lower; ?>
    <?php } 
		
		if ($this->captain) {
			// User is captain
			echo "<div class='larger-margin-top clear-right profile-buttons-second-row' style='margin-right:0'>" . $this->inviteButton . "</div>";
			echo "<div class='larger-margin-top right profile-buttons-second-row'>" . $this->manageButton . "</div>";
		}
	?>
</div>
<!--
    <div class='clear width-100 larger-margin-top'>
    	<div class='left game-rating-box green-back rounded-corners'>
        	<p class='largest-text white width-100 center heavy'>88</p>
        </div>
        <div class='left game-rating-box green-back rounded-corners'>
        	<p class='largest-text white width-100 center heavy'>88</p>
        </div>
        <div class='left game-rating-box green-back rounded-corners'>
        	<p class='largest-text white width-100 center heavy'>88</p>
        </div>
    </div>-->
<?php
// Create header for players section
$playersHeader  = "<div class='right profile-section-bold-subheader'>";
$playersHeader .= 		"<p class='right heavy darkest'>" . $this->totalPlayers . " out of " . $this->rosterLimit . "</p>";
$playersHeader .= "</div>";
/*
if ($this->nextGame) {
	$playersHeader .= "<div class='left profile-section-bold-subheader team-player-going-description-container'>";
	$playersHeader .= 		"<img class='left' src='/images/team/confirm/small.png' />";
	$playersHeader .= 		"<p class='left smaller-text medium team-players-section-header-going'>Going to next game</p>";
	$playersHeader .= 		"<img class='left' src='/images/team/deny/small.png' />";
	$playersHeader .= 		"<p class='left smaller-text medium team-players-section-header-going'>Not going to next game</p>";
	$playersHeader .= "</div>";
}*/
echo $this->partial('partials/global/sectionHeaderBold.phtml',array('title'   => 'players',
																	'content' => $playersHeader)); 

echo "<div id='team-players-container' class='clear width-100'>";

if ($this->game->players->hasValue('users')) {
	// Players exist
	echo $this->playerssection($this->game->players->users);
} else {
	echo "<p class='none-text larger-text light width-100 center'>There are no players.</p>";
}
echo "</div>";


